name: Daily Trading Algorithm (DST-Aware)

on:
  schedule:
    # Multiple times with DST handling - runs at 9:35, 9:40, 9:45 AM ET
    # Later timing ensures Yahoo Finance has market data available
    # Standard Time (Nov-Mar): ET = UTC-5
    - cron: '35 14 * 11-12,1-3 1-5'  # 9:35 AM ET (primary)
    - cron: '40 14 * 11-12,1-3 1-5'  # 9:40 AM ET (backup)
    - cron: '45 14 * 11-12,1-3 1-5'  # 9:45 AM ET (final backup)
    # Daylight Saving Time (Mar-Nov): ET = UTC-4
    - cron: '35 13 * 4-10 1-5'  # 9:35 AM EDT (primary)
    - cron: '40 13 * 4-10 1-5'  # 9:40 AM EDT (backup)
    - cron: '45 13 * 4-10 1-5'  # 9:45 AM EDT (final backup)

  workflow_dispatch:  # Allows manual trigger from GitHub UI
    inputs:
      dry_run:
        description: 'Dry run mode (no actual trades)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Fail if takes longer than 15 minutes

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check if already ran today
      id: check_run
      run: |
        # Get today's date in ET timezone
        TODAY=$(TZ='America/New_York' date +%Y-%m-%d)
        echo "Today's date (ET): $TODAY"

        # Check if we already have a successful run today
        # This prevents multiple scheduled runs from executing on the same day
        RECENT_RUNS=$(gh run list --workflow=daily-trading-dst.yml --limit 10 --json conclusion,createdAt,status --jq '.[] | select(.conclusion == "success")')

        if echo "$RECENT_RUNS" | grep -q "$TODAY"; then
          echo "already_ran=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Trading algorithm already ran successfully today. Skipping."
        else
          echo "already_ran=false" >> $GITHUB_OUTPUT
          echo "üÜï First run today. Proceeding with trading check."
        fi
      env:
        GH_TOKEN: ${{ github.token }}
      continue-on-error: true

    - name: Set up Python
      if: steps.check_run.outputs.already_ran != 'true'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache dependencies
      if: steps.check_run.outputs.already_ran != 'true'
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      if: steps.check_run.outputs.already_ran != 'true'
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy yfinance alpaca-py python-dotenv pytz schedule

    - name: Verify time and market hours
      if: steps.check_run.outputs.already_ran != 'true'
      run: |
        echo "=========================================="
        echo "Time Information"
        echo "=========================================="
        echo "UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ET Time: $(TZ='America/New_York' date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "Day of week: $(date -u '+%u') (1=Monday, 5=Friday)"
        echo ""

        # Check if it's a weekend
        if [ $(date -u '+%u') -gt 5 ]; then
          echo "‚ö†Ô∏è  Weekend detected - market is closed"
          exit 0
        fi

    - name: Run daily trading algorithm
      if: steps.check_run.outputs.already_ran != 'true'
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
        POSITION_SIZE_LIMIT: ${{ secrets.POSITION_SIZE_LIMIT }}
        LOG_LEVEL: INFO
      run: |
        echo "=========================================="
        echo "Starting Daily Trading Algorithm"
        echo "=========================================="
        python -m trading_algorithm.daily_trader
        EXIT_CODE=$?
        echo ""
        echo "Trading algorithm exit code: $EXIT_CODE"
        exit $EXIT_CODE

    - name: Commit trading state
      if: steps.check_run.outputs.already_ran != 'true'
      run: |
        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Check if state file exists and has changes
        if [ -f logs/trading_state.json ]; then
          git add logs/trading_state.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to trading state"
          else
            TODAY=$(TZ='America/New_York' date '+%Y-%m-%d %I:%M:%S %p ET')
            git commit -m "Update trading state - $TODAY"
            git push
            echo "‚úÖ Trading state committed and pushed"
          fi
        else
          echo "No trading state file found (no trades executed)"
        fi

    - name: Display daily report
      if: always()
      run: |
        if [ -f logs/daily_report.txt ]; then
          echo "=========================================="
          echo "DAILY TRADING REPORT"
          echo "=========================================="
          cat logs/daily_report.txt
        elif [ -f logs/daily_trading.log ]; then
          echo "=========================================="
          echo "Last 50 lines of trading log:"
          echo "=========================================="
          tail -50 logs/daily_trading.log
        fi

    - name: Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-logs-${{ github.run_number }}-${{ github.run_attempt }}
        path: logs/
        retention-days: 90

    - name: Create summary and send email
      if: always()
      run: |
        echo "## Trading Algorithm Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Time (ET):** $(TZ='America/New_York' date '+%Y-%m-%d %I:%M:%S %p %Z')" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f logs/daily_report.txt ]; then
          echo "### Daily Trading Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat logs/daily_report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        elif [ -f logs/daily_trading.log ]; then
          echo "### Recent Log Entries" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 logs/daily_trading.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Send email report
      if: always() && steps.*.outcome != 'skipped'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Trading Report - ${{ job.status }} - $(TZ='America/New_York' date '+%Y-%m-%d')"
        to: ${{ secrets.EMAIL_TO }}
        from: Trading Algorithm
        body: file://logs/daily_report.txt
        attachments: logs/daily_report.json,logs/daily_trading.log
        ignore_cert: false
        convert_markdown: false
        priority: normal

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Trading algorithm execution failed!"
        echo "Please check the logs and take appropriate action."
        # Add notification service here (Slack, Discord, Email, etc.)
